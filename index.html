<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Vid2Beat â€“ Audio Extractor</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
  :root{--bg:#0f0f0f;--text:#00ff88;--accent:#00ff88;--light-bg:#f5f5f5;--light-text:#007f00}
  body{font-family:'Share Tech Mono',monospace;background:var(--bg);color:var(--text);margin:0;padding:18px;display:flex;flex-direction:column;align-items:center;gap:12px}
  body.light{background:var(--light-bg);color:var(--light-text)}
  header{width:100%;max-width:980px;display:flex;align-items:center}
  h1{margin:0;font-size:1.4rem}
  .muted{margin-left:auto;opacity:.9}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
  #loadBtn{background:var(--accent);color:#001}
  #chooseBtn{background:#666;color:#fff}
  #extractBtn{background:#ffd966;color:#000}
  #themeBtn{background:#888;color:#fff}
  #dropArea{width:80%;max-width:760px;height:120px;border-radius:10px;border:2px dashed rgba(0,255,136,0.12);display:flex;align-items:center;justify-content:center;padding:12px;text-align:center;transition:all .12s}
  #dropArea.drag{border-color:var(--accent);transform:scale(1.01)}
  #progressContainer{width:80%;max-width:760px;height:16px;border-radius:8px;border:1px solid rgba(0,255,136,.12);overflow:hidden;display:none}
  #progressBar{height:100%;width:0%;background:var(--accent);transition:width .12s linear}
  audio{width:80%;max-width:760px;display:none}
  #downloadLink{display:none}
  #terminal{width:80%;max-width:760px;height:220px;border-radius:8px;padding:8px;background:#111;color:#0f0;overflow:auto;font-size:12px;white-space:pre-wrap}
  body.light #terminal{background:#eee;color:#007f00}
  footer{opacity:.9}
  input[type=file]{display:none}
  @media(max-width:520px){#dropArea{height:100px}#terminal{height:160px}}
</style>
</head>
<body>
  <header><h1>ðŸŽ§ Vid2Beat â€“ Audio Extractor</h1><div class="muted">Made by Aryan</div></header>

  <div class="controls">
    <button id="loadBtn">Load Engine (uses /ffmpeg/)</button>
    <label><button id="chooseBtn">Choose Video</button></label>
    <input id="fileInput" type="file" accept="video/*">
    <button id="extractBtn" disabled>Extract Audio</button>
    <button id="themeBtn">Toggle Theme</button>
  </div>

  <div id="dropArea">Drop a video file here or click <strong>Choose Video</strong></div>
  <div class="meta">Supported: mp4, mkv, mov, webm â€” extraction happens in-browser</div>

  <div id="progressContainer"><div id="progressBar"></div></div>
  <a id="downloadLink" href="#" download="output.mp3">Download MP3</a>
  <audio id="audioPlayer" controls></audio>
  <div id="terminal" aria-live="polite"></div>
  <footer>Made by Aryan</footer>

<script type="module">

import { createFFmpeg, fetchFile } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.2/dist/ffmpeg.min.mjs';

const loadBtn = document.getElementById('loadBtn');
const chooseBtn = document.getElementById('chooseBtn');
const fileInput = document.getElementById('fileInput');
const extractBtn = document.getElementById('extractBtn');
const themeBtn = document.getElementById('themeBtn');
const dropArea = document.getElementById('dropArea');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const audioPlayer = document.getElementById('audioPlayer');
const downloadLink = document.getElementById('downloadLink');
const terminal = document.getElementById('terminal');

let ffmpeg = null;
let engineLoaded = false;
let selectedFile = null;

function log(msg){
  const t = new Date().toLocaleTimeString();
  terminal.textContent += `[${t}] ${msg}\n`;
  terminal.scrollTop = terminal.scrollHeight;
  console.log(msg);
}
function clearLog(){ terminal.textContent = ''; }

// Apply saved theme (cookie)
(function initTheme(){
  const cookie = document.cookie.split('; ').find(r => r.startsWith('theme='));
  const theme = cookie ? cookie.split('=')[1] : 'dark';
  if(theme === 'light') document.body.classList.add('light');
  log('Theme: ' + theme);
})();
themeBtn.addEventListener('click', ()=>{
  const isLight = document.body.classList.toggle('light');
  document.cookie = 'theme=' + (isLight ? 'light' : 'dark') + ';path=/;max-age=31536000';
  log('Theme set to ' + (isLight ? 'light' : 'dark'));
});

// Drag & drop + file selection
dropArea.addEventListener('dragover', e=>{ e.preventDefault(); dropArea.classList.add('drag'); });
dropArea.addEventListener('dragleave', ()=>dropArea.classList.remove('drag'));
dropArea.addEventListener('drop', e=>{ e.preventDefault(); dropArea.classList.remove('drag'); const f = e.dataTransfer.files && e.dataTransfer.files[0]; if(f) onFileSelected(f); });
dropArea.addEventListener('click', ()=>fileInput.click());
fileInput.addEventListener('change', e => { const f = e.target.files && e.target.files[0]; if(f) onFileSelected(f); });
chooseBtn.addEventListener('click', ()=>fileInput.click());

function onFileSelected(f){
  selectedFile = f;
  audioPlayer.style.display = 'none';
  downloadLink.style.display = 'none';
  progressContainer.style.display = 'none';
  progressBar.style.width = '0%';
  log(`Selected: ${f.name} (${Math.round(f.size/1024)} KB)`);
  extractBtn.disabled = !engineLoaded;
}

// Create ffmpeg with local core paths
function createLocalFFmpeg(){
  // set these to your repo's ffmpeg folder (site root)
  const corePath = 'ffmpeg/ffmpeg-core.js';
  const wasmPath = 'ffmpeg/ffmpeg-core.wasm';
  const workerPath = 'ffmpeg/ffmpeg-worker.js';

  return createFFmpeg({
    log: true,
    corePath, // will load ffmpeg-core.js which then loads wasm/worker relative paths
    wasmPath,
    workerPath
  });
}

// Load engine button
loadBtn.addEventListener('click', async ()=>{
  if(engineLoaded){ log('Engine already loaded.'); return; }
  try{
    clearLog();
    log('Initializing FFmpeg instance (core files served from /ffmpeg/). This may take a few seconds...');
    ffmpeg = createLocalFFmpeg();

    // show ffmpeg logs in the terminal
    ffmpeg.setLogger(({ type, message }) => {
      if(type === 'info' || type === 'warn' || type === 'error') log(`[ffmpeg:${type}] ${message}`);
    });

    // progress handler
    ffmpeg.setProgress(({ ratio }) => {
      try { progressBar.style.width = Math.round(ratio*100) + '%'; } catch(e) {}
    });

    await ffmpeg.load(); // will fetch ffmpeg-core.js from /ffmpeg/
    engineLoaded = true;
    loadBtn.textContent = 'Engine Loaded';
    loadBtn.disabled = true;
    extractBtn.disabled = !selectedFile;
    log('FFmpeg loaded successfully (core from /ffmpeg/).');
  }catch(err){
    log('FFmpeg init error: ' + (err && err.message ? err.message : String(err)));
    log('Check that /ffmpeg/ffmpeg-core.js and .wasm and -worker.js are present and publicly available.');
    alert('FFmpeg initialization failed. Open DevTools Network tab to inspect requests.');
    loadBtn.disabled = false;
  }
});

// Extract audio
extractBtn.addEventListener('click', async ()=>{
  if(!engineLoaded){ alert('Please click "Load Engine" first'); return; }
  if(!selectedFile){ alert('Please select or drop a video first'); return; }

  extractBtn.disabled = true;
  clearLog();
  log('Starting extraction...');
  progressContainer.style.display = 'block';
  progressBar.style.width = '0%';
  audioPlayer.style.display = 'none';
  downloadLink.style.display = 'none';

  try{
    const ext = (selectedFile.name.split('.').pop() || 'mp4').replace(/[^a-z0-9]/gi,'').toLowerCase();
    const inName = `input_${Date.now()}.${ext}`;
    const outName = `output_${Date.now()}.mp3`;

    log('Writing file into FFmpeg FS...');
    const inputData = await fetchFile(selectedFile);
    ffmpeg.FS('writeFile', inName, inputData);

    log('Running ffmpeg - extracting audio (this can take time) ...');
    await ffmpeg.run('-i', inName, '-vn', '-q:a', '0', outName);

    log('Reading result from FS...');
    const out = ffmpeg.FS('readFile', outName);
    const blob = new Blob([out.buffer], { type: 'audio/mp3' });
    const url = URL.createObjectURL(blob);

    audioPlayer.src = url;
    audioPlayer.style.display = 'block';
    downloadLink.href = url;
    downloadLink.download = selectedFile.name.replace(/\.[^/.]+$/, '') + '.mp3';
    downloadLink.style.display = 'inline-block';

    progressBar.style.width = '100%';
    log('Extraction finished âœ… â€” preview below or download the MP3.');
    // cleanup FS
    try{ ffmpeg.FS('unlink', inName); } catch(e){}
    try{ ffmpeg.FS('unlink', outName); } catch(e){}
  }catch(err){
    log('Extraction error: ' + (err && err.message ? err.message : String(err)));
    alert('Extraction failed â€” check terminal and DevTools console for more info.');
  }finally{
    extractBtn.disabled = false;
  }
});

// on load, advise user
(function(){
  log('Ready. Ensure the folder /ffmpeg/ exists in the site root with: ffmpeg-core.js, ffmpeg-core.wasm, ffmpeg-worker.js');
  if(location.protocol === 'file:') log('Warning: Serving over file:// may block wasm/modules â€” use GitHub Pages or a local HTTP server (e.g. python -m http.server).');
  log('Click "Load Engine" to initialize, then choose or drop a video and press "Extract Audio".');
})();
</script>

</body>
</html>
